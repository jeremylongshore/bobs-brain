name: Security Scanning

on:
  push:
    branches: [ main, clean-main ]
  pull_request:
    branches: [ main, clean-main ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for gitleaks

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety pip-audit
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run Bandit (Python Security Linter)
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ -ll  # Fail on medium-high severity
      continue-on-error: false

    - name: Run Safety (Dependency Vulnerability Scanner)
      run: |
        safety check --json --output safety-report.json || true
        safety check --bare
      continue-on-error: true

    - name: Run pip-audit (PyPI Dependency Auditor)
      run: |
        pip-audit --desc --format json --output pip-audit-report.json || true
        pip-audit --desc
      continue-on-error: true

    - name: Install and Run Gitleaks (Secret Scanner)
      run: |
        wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
        tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
        ./gitleaks detect --source . --report-path gitleaks-report.json --verbose || true
        ./gitleaks detect --source . --no-git --verbose
      continue-on-error: false

    - name: Upload Security Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          pip-audit-report.json
          gitleaks-report.json
        retention-days: 30

    - name: Security Summary
      if: always()
      run: |
        echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Bandit: Python code security analysis complete" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Safety: Dependency vulnerability scan complete" >> $GITHUB_STEP_SUMMARY
        echo "âœ… pip-audit: PyPI package audit complete" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Gitleaks: Secret detection scan complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š View detailed reports in artifacts" >> $GITHUB_STEP_SUMMARY
