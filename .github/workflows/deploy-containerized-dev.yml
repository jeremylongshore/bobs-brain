name: Containerized Agent Deployment - Dev (STUBBED)

# Phase 18: Container-based deployment workflow with ARV gates
#
# This workflow demonstrates the complete containerized deployment pattern:
# 1. ARV checks (gate)
# 2. Docker build & push
# 3. Terraform apply (STUBBED in Phase 18)
#
# IMPORTANT:
# - ARV checks must pass before building images
# - Docker images pushed to GCR
# - Terraform deployment is STUBBED (commented out) in Phase 18
# - Will be enabled after Phase 18 AAR and dev environment validation
#
# Pattern: Containerized deployment (vs inline source deployment)
# References:
# - Dockerfiles: agents/bob/Dockerfile, agents/iam_senior_adk_devops_lead/Dockerfile
# - Terraform: infra/terraform/agent_engine.tf
# - Standard: 000-docs/6767-DR-STND-adk-agent-engine-spec-and-hardmode-rules.md

on:
  workflow_dispatch:
    inputs:
      agent:
        description: 'Agent to deploy (bob or foreman)'
        required: true
        type: choice
        default: 'bob'
        options:
          - bob
          - foreman
          - both

      gcp_project_id:
        description: 'GCP Project ID'
        required: true
        type: string

      gcp_region:
        description: 'GCP Region'
        required: false
        type: string
        default: 'us-central1'

permissions:
  contents: read
  id-token: write  # Required for Workload Identity Federation (R4)

env:
  GCP_PROJECT_ID: ${{ inputs.gcp_project_id }}
  GCP_REGION: ${{ inputs.gcp_region }}
  APP_VERSION: '0.10.0'
  ENVIRONMENT: dev

jobs:
  # ARV Gate: Must pass before building images
  arv-gate:
    name: ARV Checks (Deployment Gate)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt || echo "Requirements install incomplete"

      - name: Run drift detection (R8)
        run: bash scripts/ci/check_nodrift.sh

      - name: Run A2A readiness check (Phase 17)
        run: python scripts/check_a2a_readiness.py
        env:
          PYTHONPATH: .

      - name: Run ARV minimum checks
        run: make check-arv-minimum

      - name: Report ARV gate status
        run: |
          echo "‚úÖ All ARV checks passed!"
          echo "Proceeding to Docker build & push..."

  # Docker Build & Push
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: arv-gate  # Only run if ARV gate passes

    strategy:
      matrix:
        include:
          - agent: bob
            dockerfile: agents/bob/Dockerfile
            image_name: agent
            context: .
          - agent: foreman
            dockerfile: agents/iam_senior_adk_devops_lead/Dockerfile
            image_name: foreman
            context: .

    # Only build requested agent(s)
    if: |
      inputs.agent == 'both' ||
      inputs.agent == matrix.agent

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker gcr.io

      - name: Build Docker image (${{ matrix.agent }})
        run: |
          echo "üê≥ Building ${{ matrix.agent }} image..."
          docker build \
            -t gcr.io/${{ env.GCP_PROJECT_ID }}/${{ matrix.image_name }}:${{ env.APP_VERSION }} \
            -t gcr.io/${{ env.GCP_PROJECT_ID }}/${{ matrix.image_name }}:latest \
            -f ${{ matrix.dockerfile }} \
            ${{ matrix.context }}

      - name: Push Docker image to GCR (${{ matrix.agent }})
        run: |
          echo "üì¶ Pushing ${{ matrix.agent }} image to GCR..."
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/${{ matrix.image_name }}:${{ env.APP_VERSION }}
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/${{ matrix.image_name }}:latest

      - name: Report image details
        run: |
          echo "‚úÖ Image pushed successfully!"
          echo "   Agent: ${{ matrix.agent }}"
          echo "   Image: gcr.io/${{ env.GCP_PROJECT_ID }}/${{ matrix.image_name }}:${{ env.APP_VERSION }}"
          echo "   Latest: gcr.io/${{ env.GCP_PROJECT_ID }}/${{ matrix.image_name }}:latest"

  # Inline Source Deployment (Phase 19)
  # IMPORTANT: This workflow name says "containerized" but actual deployment
  # uses INLINE SOURCE pattern per 6767-INLINE standard.
  # Docker images built above are for future consideration/experimentation.
  deploy-inline-source:
    name: Deploy via Inline Source (MANUAL SETUP REQUIRED)
    runs-on: ubuntu-latest
    needs: arv-gate  # Does NOT depend on Docker build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Check required environment variables
        run: |
          echo "üîç Checking required environment variables..."

          # Check GitHub secrets
          if [ -z "${{ secrets.WIF_PROVIDER }}" ]; then
            echo "‚ùå ERROR: WIF_PROVIDER secret not configured"
            echo "   Set up Workload Identity Federation in GCP and add to GitHub secrets"
            exit 1
          fi

          if [ -z "${{ secrets.WIF_SERVICE_ACCOUNT }}" ]; then
            echo "‚ùå ERROR: WIF_SERVICE_ACCOUNT secret not configured"
            echo "   Configure service account with Agent Engine permissions"
            exit 1
          fi

          # Check workflow inputs
          if [ -z "${{ inputs.gcp_project_id }}" ]; then
            echo "‚ùå ERROR: gcp_project_id input not provided"
            exit 1
          fi

          echo "‚úÖ All required environment variables present"

      - name: MANUAL SETUP REQUIRED - Inline Source Deployment
        run: |
          echo "üìã MANUAL SETUP REQUIRED FOR INLINE SOURCE DEPLOYMENT"
          echo ""
          echo "This workflow is ready to build Docker images and run ARV checks."
          echo "However, actual Agent Engine deployment requires manual setup:"
          echo ""
          echo "REQUIRED MANUAL STEPS:"
          echo "  1. GCP Project Setup:"
          echo "     - Create GCP project: ${{ inputs.gcp_project_id }}"
          echo "     - Enable Vertex AI API"
          echo "     - Enable Agent Engine API"
          echo ""
          echo "  2. Workload Identity Federation (R4):"
          echo "     - Configure WIF pool and provider"
          echo "     - Grant service account Agent Engine permissions"
          echo "     - Add WIF_PROVIDER and WIF_SERVICE_ACCOUNT to GitHub secrets"
          echo ""
          echo "  3. Terraform Backend:"
          echo "     - Create GCS bucket for Terraform state"
          echo "     - Configure backend in infra/terraform/main.tf"
          echo ""
          echo "  4. Inline Source Deployment Script:"
          echo "     - Run: python scripts/deploy_inline_source.py --agent bob --env dev"
          echo "     - Or: python scripts/deploy_inline_source.py --agent foreman --env dev"
          echo "     - Script deploys source code directly to Agent Engine"
          echo ""
          echo "  5. Import to Terraform (after manual deploy):"
          echo "     - terraform import google_vertex_ai_reasoning_engine.bob AGENT_ID"
          echo "     - terraform import google_vertex_ai_reasoning_engine.foreman AGENT_ID"
          echo ""
          echo "CURRENT STATUS:"
          echo "  ‚úÖ ARV checks: Passed"
          echo "  ‚úÖ Docker images: Built and pushed to GCR"
          echo "  ‚è∏Ô∏è  Agent Engine deployment: Manual setup required"
          echo ""
          echo "See: 000-docs/6767-INLINE-DR-STND-inline-source-deployment-for-vertex-agent-engine.md"
          echo ""
          echo "To enable automated deployment:"
          echo "  1. Complete manual setup steps above"
          echo "  2. Create scripts/deploy_inline_source.py if not exists"
          echo "  3. Uncomment deployment commands below"

      # COMMENTED OUT: Actual inline source deployment
      # Uncomment after completing manual setup steps above
      #
      # - name: Deploy bob via inline source
      #   if: inputs.agent == 'bob' || inputs.agent == 'both'
      #   run: |
      #     python scripts/deploy_inline_source.py \
      #       --agent bob \
      #       --project-id ${{ inputs.gcp_project_id }} \
      #       --region ${{ inputs.gcp_region }} \
      #       --env dev \
      #       --app-version ${{ env.APP_VERSION }}
      #
      # - name: Deploy foreman via inline source
      #   if: inputs.agent == 'foreman' || inputs.agent == 'both'
      #   run: |
      #     python scripts/deploy_inline_source.py \
      #       --agent foreman \
      #       --project-id ${{ inputs.gcp_project_id }} \
      #       --region ${{ inputs.gcp_region }} \
      #       --env dev \
      #       --app-version ${{ env.APP_VERSION }}

      - name: Report deployment status
        run: |
          echo "üìä Deployment Summary:"
          echo "  Environment: ${{ env.ENVIRONMENT }}"
          echo "  Project: ${{ inputs.gcp_project_id }}"
          echo "  Region: ${{ inputs.gcp_region }}"
          echo "  Version: ${{ env.APP_VERSION }}"
          echo ""
          echo "  Agent(s): ${{ inputs.agent }}"
          echo "  Deployment method: Inline Source (6767-INLINE)"
          echo ""
          echo "‚ÑπÔ∏è  Docker images built for future/experimental use"
          echo "‚ÑπÔ∏è  Actual deployment requires manual setup (see above)"

  # Post-Deployment Smoke Tests (Phase 19 Task 4)
  smoke-tests:
    name: Smoke Test Deployed Agents
    runs-on: ubuntu-latest
    needs: deploy-inline-source
    if: always()  # Run even if deploy was skipped, but will fail if no agents deployed

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt || echo "Requirements install incomplete"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Check deployment status
        id: check_deployment
        run: |
          echo "üîç Checking if agents are actually deployed..."
          echo ""
          echo "‚ÑπÔ∏è  NOTE: Smoke tests require agents to be deployed to Agent Engine."
          echo "   Current workflow stubs actual deployment (manual setup required)."
          echo ""
          echo "   If you have manually deployed agents, set SMOKE_TEST_ENABLED=true"
          echo "   as a GitHub Actions environment variable to run smoke tests."
          echo ""

          if [ "${{ vars.SMOKE_TEST_ENABLED }}" == "true" ]; then
            echo "deployment_ready=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Smoke tests enabled (SMOKE_TEST_ENABLED=true)"
          else
            echo "deployment_ready=false" >> $GITHUB_OUTPUT
            echo "‚è∏Ô∏è  Smoke tests disabled (SMOKE_TEST_ENABLED not set)"
            echo "   Set SMOKE_TEST_ENABLED=true in repository variables to enable"
          fi

      - name: Smoke test bob
        if: |
          steps.check_deployment.outputs.deployment_ready == 'true' &&
          (inputs.agent == 'bob' || inputs.agent == 'both')
        run: |
          echo "üß™ Running smoke test for bob..."
          python scripts/smoke_test_agent_engine.py \
            --project ${{ inputs.gcp_project_id }} \
            --location ${{ inputs.gcp_region }} \
            --agent bob \
            --env dev
        env:
          PROJECT_ID: ${{ inputs.gcp_project_id }}
          LOCATION: ${{ inputs.gcp_region }}
          AGENT_NAME: bob
          ENV: dev

      - name: Smoke test foreman
        if: |
          steps.check_deployment.outputs.deployment_ready == 'true' &&
          (inputs.agent == 'foreman' || inputs.agent == 'both')
        run: |
          echo "üß™ Running smoke test for foreman..."
          python scripts/smoke_test_agent_engine.py \
            --project ${{ inputs.gcp_project_id }} \
            --location ${{ inputs.gcp_region }} \
            --agent iam-senior-adk-devops-lead \
            --env dev
        env:
          PROJECT_ID: ${{ inputs.gcp_project_id }}
          LOCATION: ${{ inputs.gcp_region }}
          AGENT_NAME: iam-senior-adk-devops-lead
          ENV: dev

      - name: Smoke test summary
        if: always()
        run: |
          echo "üìä Smoke Test Summary:"
          echo ""

          if [ "${{ steps.check_deployment.outputs.deployment_ready }}" == "true" ]; then
            echo "  Status: Smoke tests executed"
            echo "  Agents tested: ${{ inputs.agent }}"
            echo ""
            echo "  Check step results above for pass/fail status"
          else
            echo "  Status: Smoke tests skipped (agents not deployed)"
            echo "  Agents requested: ${{ inputs.agent }}"
            echo ""
            echo "  To enable smoke tests:"
            echo "    1. Deploy agents manually using scripts/deploy_inline_source.py"
            echo "    2. Set SMOKE_TEST_ENABLED=true in repository variables"
            echo "    3. Re-run this workflow"
          fi
