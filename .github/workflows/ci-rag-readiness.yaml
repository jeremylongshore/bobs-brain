name: RAG Readiness Check (DEPRECATED)

# ‚ö†Ô∏è DEPRECATION NOTICE:
# This workflow is REDUNDANT with ARV-DEPT (arv-department job in ci.yml).
# The `rag-readiness` check is now part of comprehensive ARV framework.
# This workflow will be REMOVED in a future update.
#
# Use `make arv-department` or the `arv-department` job in ci.yml instead.
#
# Part of Agent Readiness Verification (ARV) gates
# Validates Bob and foreman are structurally ready for RAG

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'agents/shared_tools/**'
      - 'config/vertex_search.yaml'
      - 'scripts/check_rag_readiness.py'
      - 'scripts/print_rag_config.py'
      - '.github/workflows/ci-rag-readiness.yaml'

  push:
    branches: [main]
    paths:
      - 'agents/shared_tools/**'
      - 'config/vertex_search.yaml'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Run in verbose mode'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  PYTHON_VERSION: '3.11'
  # Default environment for checks
  APP_ENV: 'staging'
  USE_ORG_KNOWLEDGE: 'true'

jobs:
  rag-readiness:
    name: RAG Readiness Gate
    runs-on: ubuntu-latest

    # Currently SOFT enforcement - change to true for HARD enforcement
    continue-on-error: false

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: üìã Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml  # Required for config parsing
          # Install other deps if requirements.txt exists
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: üîç Check RAG configuration
        run: |
          echo "Checking RAG configuration..."
          python scripts/print_rag_config.py

      - name: ‚úÖ Run RAG readiness check
        id: rag_check
        run: |
          if [ "${{ github.event.inputs.verbose }}" == "true" ] || [ "${{ runner.debug }}" == "1" ]; then
            echo "Running verbose RAG readiness check..."
            python scripts/check_rag_readiness.py --verbose
          else
            echo "Running RAG readiness check..."
            python scripts/check_rag_readiness.py
          fi

      - name: üìä Generate readiness report
        if: always()
        run: |
          echo "## RAG Readiness Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.rag_check.outcome }}" == "success" ]; then
            echo "‚úÖ **RAG Ready**: Bob and foreman are structurally ready for Vertex AI Search" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Not Ready**: Missing RAG requirements - see logs for details" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: \`${{ env.APP_ENV }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Use Org Knowledge: \`${{ env.USE_ORG_KNOWLEDGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Run \`make check-rag-readiness\` locally to debug" >> $GITHUB_STEP_SUMMARY
          echo "2. Check \`config/vertex_search.yaml\` is valid" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify tool factory imports work" >> $GITHUB_STEP_SUMMARY

      - name: üìù Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ùå RAG Readiness Check Failed

              The RAG readiness gate has detected issues with the Vertex AI Search integration.

              **Required Actions:**
              1. Run \`make check-rag-readiness-verbose\` locally
              2. Fix any missing configuration or code issues
              3. Ensure all 6767 docs are present

              See the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

              ---
              *This is part of the Agent Readiness Verification (ARV) system.*`
            })

  # Future ARV gates can be added here
  # schema-validation:
  #   name: Schema Validation Gate
  #   ...

  # golden-tests:
  #   name: Golden Tests Gate
  #   ...